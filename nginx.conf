load_module modules/ngx_http_geoip2_module.so;

user                   nginx;
worker_processes       auto;

error_log              /var/log/nginx/error.log notice;
pid                    /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include            /etc/nginx/mime.types;
    default_type       application/octet-stream;
    log_format main '[$time_local] remote_addr: $remote_addr http_x_forwarded_for: $http_x_forwarded_for '
                      'country code: $geoip2_data_country_code, allowed country: $allowed_country '
                      'status: $status bytes: $body_bytes_sent';

    access_log        /var/log/nginx/access.log main;

    sendfile          on;

    keepalive_timeout 65;

    gzip              on;

    map $http_x_forwarded_for $client_ip {
        default $http_x_forwarded_for;
        ''      $remote_addr;
    }

    geoip2 /etc/nginx/geoip/GeoLite2-Country.mmdb {
        auto_reload   5m;
        $geoip2_data_country_code source=$client_ip country iso_code;
    }

    map $geoip2_data_country_code $allowed_country {
        default yes;
        CN no;
    }

    include           /etc/nginx/conf.d/*.conf;
}
